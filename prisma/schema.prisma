generator client {
  provider = "prisma-client-js"
  // output   = "../generated/prisma"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(auto()) @map("_id") @db.ObjectId
  uid          String
  name         String
  phone        String
  verified     Boolean   @default(false)
  email        String    @unique
  passwordHash String?
  picture      String?
  role         Role      @default(guest)
  authChannel  AuthChannel?
  otpHash      String?
  otpExpiresAt DateTime?
  deleted      Boolean   @default(false)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  listings     Listing[]
  serviceListings ServiceListing[]
  experienceListings ExperienceListing[]
  wishlistCategories WishlistCategory[]
  wishlist     WishlistItem[]
  bookings     Booking[] @relation("UserBookings")
  messagesSent Message[] @relation("MessagesSent")
  messagesRecv Message[] @relation("MessagesReceived")
  reviewsGiven Review[]  @relation("ReviewsGiven")
  reviewsRecvd Review[]  @relation("ReviewsRecieved")
  tokens       Token[]
}

model Listing {
  id                 String   @id @default(auto()) @map("_id") @db.ObjectId
  name               String
  hostId             String   @db.ObjectId
  description        String?
  address            String?
  lat                Float?
  lng                Float?
  images             String[]
  pricePerNight      String?
  weekendPrice       String?
  minNights          Int?     @default(1)
  guests             Int?     @default(1)
  beds               Int?     @default(1)
  bedRooms           Int?     @default(1)
  bathRooms          Int?     @default(1)
  unavailableDates   String[]
  country            String?
  category           String?
  rating             Float?
  amenities          String[]
  rules              String?
  cancellationPolicy String?
  picture            String?
  deleted            Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relations
  host     User      @relation(fields: [hostId], references: [id])
  bookings Booking[]
  messages Message[]
  reviews  Review[]
  wishlistedBy WishlistItem[]
}

model WishlistItem {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  listingId String?  @db.ObjectId
  serviceListingId String? @db.ObjectId
  experienceListingId String? @db.ObjectId
  categoryId String   @db.ObjectId
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id])
  listing Listing? @relation(fields: [listingId], references: [id])
  serviceListing ServiceListing? @relation(fields: [serviceListingId], references: [id])
  experienceListing ExperienceListing? @relation(fields: [experienceListingId], references: [id])
  category WishlistCategory @relation(fields: [categoryId], references: [id])
}

model WishlistCategory {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  name      String
  createdAt DateTime @default(now())

  user  User @relation(fields: [userId], references: [id])
  items WishlistItem[]

  @@unique([userId, name])
}

model AppSettings {
  id                         String   @id @default(auto()) @map("_id") @db.ObjectId
  guestFavoriteMinWishlistCount Int   @default(5)
  createdAt                  DateTime @default(now())
  updatedAt                  DateTime @updatedAt
}

model Booking {
  id         String        @id @default(auto()) @map("_id") @db.ObjectId
  name       String
  picture    String?
  listingId  String?       @db.ObjectId
  serviceListingId String? @db.ObjectId
  experienceListingId String? @db.ObjectId
  guestId    String        @db.ObjectId
  startDate  DateTime
  endDate    DateTime
  totalPrice Int?
  status     BookingStatus @default(pending)
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  // Relations
  listing Listing? @relation(fields: [listingId], references: [id])
  serviceListing ServiceListing? @relation(fields: [serviceListingId], references: [id])
  experienceListing ExperienceListing? @relation(fields: [experienceListingId], references: [id])
  guest   User    @relation("UserBookings", fields: [guestId], references: [id])
}

model Message {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  fromUserId String   @db.ObjectId
  toUserId   String   @db.ObjectId
  listingId  String   @db.ObjectId
  content    String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  fromUser User    @relation("MessagesSent", fields: [fromUserId], references: [id])
  toUser   User    @relation("MessagesReceived", fields: [toUserId], references: [id])
  listing  Listing @relation(fields: [listingId], references: [id])
}

model Review {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  bookingId  String?  @db.ObjectId
  reviewerId String?  @db.ObjectId
  revieweeId String?  @db.ObjectId
  rating     Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  comment String

  reviewer  User?   @relation("ReviewsGiven", fields: [reviewerId], references: [id])
  reviewee  User?   @relation("ReviewsRecieved", fields: [revieweeId], references: [id])
  listingId String  @db.ObjectId
  listing   Listing @relation(fields: [listingId], references: [id])
}

model Token {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String   @db.ObjectId
  tokenHash  String
  createdAt  DateTime @default(now())
  lastUsedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

enum Role {
  guest
  host
  both
}

enum AuthChannel {
  email
  phone
  google
  facebook
  apple
}

enum BookingStatus {
  pending
  confirmed
  cancelled
}

model ServiceListing {
  id                  String   @id @default(auto()) @map("_id") @db.ObjectId
  hostId              String   @db.ObjectId
  intro               String?
  expertise           String?
  yearsOfExperience   Int?
  socialProfiles      String[]
  location            String?
  photos              String[]
  itinerary           Json[]   // [{title, description, duration, icon/image}]
  pricing             Json?    // {maxGuest, pricePerGuest, privateGroupMinimum}
  details             Json?    // {isTransporting, transportMethods}
  title               String?
  description         String?
  country             String?
  category            String?
  status              ListingStatus @default(pending)
  deleted             Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  host     User      @relation(fields: [hostId], references: [id])
  bookings Booking[]
  wishlistedBy WishlistItem[]
}

model ExperienceListing {
  id                  String   @id @default(auto()) @map("_id") @db.ObjectId
  hostId              String   @db.ObjectId
  intro               String?
  expertise           String?
  yearsOfExperience   Int?
  socialProfiles      String[]
  location            String?
  photos              String[]
  itinerary           Json[]
  pricing             Json?
  details             Json?
  title               String?
  description         String?
  country             String?
  category            String?
  status              ListingStatus @default(pending)
  deleted             Boolean  @default(false)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  host     User      @relation(fields: [hostId], references: [id])
  bookings Booking[]
  wishlistedBy WishlistItem[]
}

enum ListingStatus {
  pending
  action_required
  completed
  in_review
  active
  inactive
}
